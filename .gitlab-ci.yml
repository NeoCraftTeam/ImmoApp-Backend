# Pipeline GitLab CI/CD pour Laravel avec sÃ©curitÃ© et dÃ©ploiement

stages:
  - test
  - security
  - deploy

variables:
  POSTGRES_DB: laravel_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: secret
  DB_HOST: postgres
  DB_CONNECTION: pgsql

# Tests unitaires et fonctionnels
test:laravel:
  stage: test
  image: php:8.2-fpm
  services:
    - name: postgis/postgis:15-3.3
      alias: postgres
  before_script:
    # Installation des dÃ©pendances systÃ¨me
    - apt-get update -qq && apt-get install -y -qq git curl libzip-dev libpq-dev unzip
    - docker-php-ext-install pdo_pgsql pgsql zip

    # Installation de Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

    # Installation des dÃ©pendances Laravel
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts

    # Configuration de l'environnement de test
    - cp .env.example .env
    - php artisan key:generate
    - php artisan config:clear

  script:
    # ExÃ©cution des migrations (PostGIS sera activÃ© automatiquement si configurÃ© dans les migrations)
    - php artisan migrate --force

    # ExÃ©cution des tests
    - php artisan test

  only:
    - main
    - develop
    - merge_requests

# Analyse de sÃ©curitÃ© - SAST
sast:
  stage: security
  include:
    - template: Security/SAST.gitlab-ci.yml

# DÃ©tection de secrets
secret_detection:
  stage: security
  include:
    - template: Security/Secret-Detection.gitlab-ci.yml

# Analyse des dÃ©pendances
dependency_scanning:
  stage: security
  include:
    - template: Security/Dependency-Scanning.gitlab-ci.yml

# DÃ©ploiement sur VPS
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    # Installation d'OpenSSH
    - apk add --no-cache openssh-client git

    # Configuration SSH
    - eval $(ssh-agent -s)
    # DÃ©coder la clÃ© privÃ©e depuis Base64
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  script:
    - |
      ssh $VPS_USER@$VPS_HOST "
        set -e
        echo 'ðŸš€ DÃ©but du dÃ©ploiement...'

        # Navigation vers le rÃ©pertoire du projet
        cd $VPS_PATH

        # Mise en mode maintenance
        php artisan down || true

        # Mise Ã  jour du code
        echo 'ðŸ“¥ RÃ©cupÃ©ration du code...'
        git fetch origin main
        git reset --hard origin/main

        # Installation/mise Ã  jour des dÃ©pendances Composer
        echo 'ðŸ“¦ Installation des dÃ©pendances...'
        composer install --no-dev --optimize-autoloader --no-interaction

        # Optimisation et nettoyage
        echo 'ðŸ§¹ Nettoyage des caches...'
        php artisan cache:clear
        php artisan config:clear
        php artisan route:clear
        php artisan view:clear

        # VÃ©rification et activation de l'extension PostGIS (si nÃ©cessaire)
        echo 'ðŸ—ºï¸  VÃ©rification de PostGIS...'
        php artisan db:check-postgis || echo 'PostGIS dÃ©jÃ  activÃ© ou commande non disponible'

        # ExÃ©cution des migrations
        echo 'ðŸ—„ï¸  ExÃ©cution des migrations...'
        php artisan migrate --force

        # Optimisation pour la production
        echo 'âš¡ Optimisation...'
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        php artisan event:cache

        # Permissions des fichiers
        echo 'ðŸ”’ Configuration des permissions...'
        chmod -R 775 storage bootstrap/cache
        chown -R www-data:www-data storage bootstrap/cache

        # RedÃ©marrage des workers Queue (si vous utilisez Laravel Queue)
        # php artisan queue:restart

        # Sortie du mode maintenance
        php artisan up

        echo 'âœ… DÃ©ploiement terminÃ© avec succÃ¨s!'
      "

  only:
    - main

  when: manual  # DÃ©ploiement manuel, retirez cette ligne pour un dÃ©ploiement automatique

  environment:
    name: production
    url: https://votre-domaine.com

# DÃ©ploiement sur environnement de staging (optionnel)
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git
    - eval $(ssh-agent -s)
    # DÃ©coder la clÃ© privÃ©e depuis Base64
    - echo "$SSH_PRIVATE_KEY_STAGING" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $VPS_HOST_STAGING >> ~/.ssh/known_hosts

  script:
    - |
      ssh $VPS_USER_STAGING@$VPS_HOST_STAGING "
        cd $VPS_PATH_STAGING
        git fetch origin develop
        git reset --hard origin/develop
        composer install --optimize-autoloader --no-interaction
        php artisan migrate --force
        php artisan cache:clear
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
      "

  only:
    - develop

  environment:
    name: staging
    url: https://staging.votre-domaine.com
