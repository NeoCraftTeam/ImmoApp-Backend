image: php:8.2

stages:
  - test
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - vendor/

services:
  - name: postgis/postgis:15-3.3
    alias: postgres
    command: ["postgres", "-c", "fsync=off", "-c", "full_page_writes=off"]

variables:
  DB_CONNECTION: pgsql
  DB_HOST: postgres
  DB_PORT: 5432
  DB_DATABASE: testing
  DB_USERNAME: postgres
  DB_PASSWORD: password
  CACHE_DRIVER: redis
  REDIS_HOST: redis

# Ã‰tape 1 : Tests (Tourne sur le Runner GitLab pour isolation)
test_suite:
  stage: test
  before_script:
    - apt-get update && apt-get install -y unzip git libzip-dev libicu-dev libpq-dev libpng-dev libonig-dev
    - docker-php-ext-install pdo_pgsql zip intl exif bcmath gd
    - pecl install redis && docker-php-ext-enable redis
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --no-ansi --no-interaction --no-progress --prefer-dist
    - cp .env.example .env
    - php artisan key:generate
  script:
    - php artisan test
  only:
    - branches
    - merge_requests

# Ã‰tape 2 : DÃ©ploiement (Tourne sur VOTRE VPS - Gratuit, ZÃ©ro minute)
production_deploy:
  stage: deploy
  script:
    - echo "ðŸš€ DÃ©ploiement sur le VPS via Runner local..."
    - cd /var/www/ImmoApp-Backend || exit 1
    - bash deploy.sh
  tags:
    - self-hosted-shell
  only:
    - main
