# Pipeline GitLab CI/CD DevOps pour Laravel - Production
# OptimisÃ© pour une meilleure visualisation

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml

# ==========================================
# DÃ‰FINITION DES STAGES (ordre d'exÃ©cution)
# ==========================================
stages:
  - build
  - test
  - security
  - deploy
  - verify
  - notify
  - maintenance

# ==========================================
# VARIABLES GLOBALES
# ==========================================
variables:
  # PostgreSQL pour les tests
  POSTGRES_DB: laravel_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: secret
  DB_HOST: postgres
  DB_CONNECTION: pgsql

  # Configuration SAST
  SAST_EXCLUDED_PATHS: "spec,test,tests,tmp,vendor"

  # Optimisations GitLab
  GIT_DEPTH: 10
  FF_USE_FASTZIP: "true"
  CACHE_COMPRESSION_LEVEL: "fast"

# ==========================================
# STAGE: BUILD - Compilation des assets
# ==========================================
ðŸ—ï¸ build:frontend:
  stage: build
  image: node:20-alpine
  cache:
    key: ${CI_COMMIT_REF_SLUG}-npm
    paths:
      - node_modules/
      - .npm/
  before_script:
    - echo "ðŸ“¦ Configuration du cache npm..."
    - npm config set cache .npm --global
  script:
    - echo "ðŸ“¥ Installation des dÃ©pendances npm..."
    - npm ci --prefer-offline --no-audit
    - echo "ðŸ—ï¸ Build des assets frontend..."
    - npm run build
    - echo "âœ… Build terminÃ© avec succÃ¨s!"
  artifacts:
    name: "frontend-assets-${CI_COMMIT_SHORT_SHA}"
    paths:
      - public/build/
    expire_in: 1 day
  only:
    - main
  # Commentez ce job si vous n'utilisez pas npm/Vite

ðŸ—ï¸ build:dependencies:
  stage: build
  image: composer:latest
  cache:
    key: ${CI_COMMIT_REF_SLUG}-composer
    paths:
      - vendor/
  script:
    - echo "ðŸ“¦ Installation des dÃ©pendances Composer..."
    - composer install --prefer-dist --no-dev --optimize-autoloader --no-interaction --no-progress
    - echo "âœ… DÃ©pendances installÃ©es!"
  artifacts:
    name: "composer-vendor-${CI_COMMIT_SHORT_SHA}"
    paths:
      - vendor/
    expire_in: 1 day
  only:
    - main

# ==========================================
# STAGE: TEST - Tests automatisÃ©s
# ==========================================
ðŸ§ª test:unit:
  stage: test
  image: php:8.4-fpm
  services:
    - name: postgis/postgis:15-3.3
      alias: postgres
      variables:
        POSTGRES_DB: laravel_test
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: secret
        POSTGRES_HOST_AUTH_METHOD: trust
  variables:
    DB_CONNECTION: pgsql
    DB_HOST: postgres
    DB_PORT: 5432
    DB_DATABASE: laravel_test
    DB_USERNAME: postgres
    DB_PASSWORD: secret
  cache:
    key: ${CI_COMMIT_REF_SLUG}-composer-test
    paths:
      - vendor/
  before_script:
    - echo "ðŸ”§ Installation des extensions PHP..."
    - apt-get update -qq && apt-get install -y -qq git curl libzip-dev libpq-dev unzip libicu-dev
    - docker-php-ext-configure intl
    - docker-php-ext-install pdo_pgsql pgsql zip intl exif

    - echo "ðŸ“¥ Installation de Composer..."
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

    - echo "ðŸ“¦ Installation des dÃ©pendances..."
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress

    - echo "âš™ï¸ Configuration de l'environnement de test..."
    - cp .env.example .env
    - php artisan key:generate
    - sed -i "s/DB_CONNECTION=.*/DB_CONNECTION=pgsql/" .env
    - sed -i "s/DB_HOST=.*/DB_HOST=postgres/" .env
    - sed -i "s/DB_PORT=.*/DB_PORT=5432/" .env
    - sed -i "s/DB_DATABASE=.*/DB_DATABASE=laravel_test/" .env
    - sed -i "s/DB_USERNAME=.*/DB_USERNAME=postgres/" .env
    - sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=secret/" .env
    - php artisan config:clear

    - echo "ðŸ—„ï¸ ExÃ©cution des migrations..."
    - php artisan migrate --force --seed

  script:
    - echo "ðŸ§ª Lancement des tests unitaires..."
    - php artisan test --parallel --coverage-text --coverage-clover=coverage.xml

  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
    expire_in: 1 week

  coverage: '/^\s*Lines:\s*\d+.\d+\%/'

  only:
    - main
    - merge_requests

ðŸ§ª test:code-quality:
  stage: test
  image: php:8.4-cli
  before_script:
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --prefer-dist --no-interaction
  script:
    - echo "ðŸ” Analyse de la qualitÃ© du code..."
    - vendor/bin/phpstan analyse --memory-limit=2G || echo "âš ï¸ PHPStan non configurÃ©"
    - vendor/bin/pint --test || echo "âš ï¸ Laravel Pint non configurÃ©"
  only:
    - main
    - merge_requests
  allow_failure: true

# ==========================================
# STAGE: SECURITY - Analyses de sÃ©curitÃ©
# ==========================================
ðŸ”’ security:dependencies:
  stage: security
  image: composer:latest
  script:
    - echo "ðŸ”’ VÃ©rification des vulnÃ©rabilitÃ©s Composer..."
    - composer audit || echo "âš ï¸ VulnÃ©rabilitÃ©s dÃ©tectÃ©es"
  only:
    - main
    - merge_requests
  allow_failure: true

# ==========================================
# STAGE: DEPLOY - DÃ©ploiement Production
# ==========================================
ðŸš€ deploy:production:
  stage: deploy
  image: alpine:latest
  needs:
    - job: ðŸ§ª test:unit
      artifacts: false
    # - job: ðŸ—ï¸ build:frontend
    #   artifacts: true  # DÃ©commentez si vous utilisez npm
  before_script:
    - echo "ðŸ” Configuration SSH..."
    - apk add --no-cache openssh-client git curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  script:
    - echo "ðŸš€ DÃ©but du dÃ©ploiement sur $VPS_HOST..."
    - |
      ssh $VPS_USER@$VPS_HOST "
        set -e

        echo '================================================'
        echo 'ðŸš€ DÃ‰PLOIEMENT PRODUCTION - Laravel'
        echo '================================================'
        echo 'Pipeline: #$CI_PIPELINE_ID'
        echo 'Commit: $CI_COMMIT_SHORT_SHA'
        echo 'Auteur: $GITLAB_USER_LOGIN'
        echo 'Date: \$(date +%Y-%m-%d\ %H:%M:%S)'
        echo '================================================'

        cd $VPS_PATH

        # VÃ©rification du rÃ©pertoire Laravel
        if [ ! -f 'artisan' ]; then
          echo 'âŒ Erreur: fichier artisan non trouvÃ©'
          exit 1
        fi

        # DÃ©tection de la version PHP
        PHP_VERSION=\$(php -r \"echo PHP_MAJOR_VERSION.'.'.PHP_MINOR_VERSION;\")
        echo \"ðŸ“Œ Version PHP: \$PHP_VERSION\"

        # Sauvegarder le commit actuel pour rollback
        CURRENT_COMMIT=\$(git rev-parse HEAD 2>/dev/null || echo 'unknown')
        echo \$CURRENT_COMMIT > /tmp/last_commit_keyhome.txt
        echo \"ðŸ“Œ Commit actuel sauvegardÃ©: \$CURRENT_COMMIT\"

        # ==========================================
        # 1. BACKUP BASE DE DONNÃ‰ES
        # ==========================================
        echo ''
        echo 'ðŸ’¾ Backup de la base de donnÃ©es...'
        BACKUP_DIR=/var/backups/keyhome
        mkdir -p \$BACKUP_DIR
        BACKUP_FILE=\$BACKUP_DIR/db_\$(date +%Y%m%d_%H%M%S).sql

        DB_NAME=\$(grep DB_DATABASE .env | cut -d '=' -f2)
        pg_dump \$DB_NAME > \$BACKUP_FILE 2>/dev/null || echo 'âš ï¸ Backup Ã©chouÃ© (ignorÃ©)'

        if [ -f \$BACKUP_FILE ]; then
          gzip \$BACKUP_FILE
          echo \"âœ… Backup crÃ©Ã©: \$BACKUP_FILE.gz\"
          # Garder seulement les 10 derniers backups
          ls -t \$BACKUP_DIR/db_*.sql.gz 2>/dev/null | tail -n +11 | xargs -r rm
          echo \"ðŸ—‘ï¸ Anciens backups nettoyÃ©s\"
        fi

        # ==========================================
        # 2. MODE MAINTENANCE
        # ==========================================
        echo ''
        echo 'ðŸ”’ Activation du mode maintenance...'
        php artisan down --retry=60 --secret=\"deploy-secret-\$(date +%s)\" || echo 'âš ï¸ DÃ©jÃ  en maintenance'

        # ==========================================
        # 3. MISE Ã€ JOUR DU CODE
        # ==========================================
        echo ''
        echo 'ðŸ“¥ RÃ©cupÃ©ration du code depuis Git...'
        git fetch origin main
        git reset --hard origin/main
        NEW_COMMIT=\$(git rev-parse HEAD)
        echo \"âœ… Nouveau commit: \$NEW_COMMIT\"

        # ==========================================
        # 4. NETTOYAGE DES CACHES
        # ==========================================
        echo ''
        echo 'ðŸ§¹ Nettoyage de tous les caches...'
        php artisan config:clear && echo '  âœ“ Config cache cleared'
        php artisan cache:clear && echo '  âœ“ Application cache cleared'
        php artisan route:clear && echo '  âœ“ Route cache cleared'
        php artisan view:clear && echo '  âœ“ View cache cleared'
        php artisan optimize:clear && echo '  âœ“ Optimize cache cleared'
        php artisan event:clear 2>/dev/null && echo '  âœ“ Event cache cleared' || echo '  âš ï¸ Event cache non disponible'

        # ==========================================
        # 5. INSTALLATION DES DÃ‰PENDANCES
        # ==========================================
        echo ''
        echo 'ðŸ“¦ Installation des dÃ©pendances Composer...'
        composer install --no-dev --optimize-autoloader --no-interaction
        echo 'âœ… DÃ©pendances Composer installÃ©es'

        # ==========================================
        # 6. MIGRATIONS DE LA BASE DE DONNÃ‰ES
        # ==========================================
        echo ''
        echo 'ðŸ—„ï¸ ExÃ©cution des migrations...'
        php artisan migrate --force
        echo 'âœ… Migrations terminÃ©es'

        # ==========================================
        # 7. GÃ‰NÃ‰RATION SWAGGER (L5-Swagger)
        # ==========================================
        echo ''
        echo 'ðŸ“š GÃ©nÃ©ration de la documentation Swagger...'
        php artisan l5-swagger:generate 2>/dev/null && echo 'âœ… Documentation Swagger gÃ©nÃ©rÃ©e' || echo 'âš ï¸ L5-Swagger non installÃ©'

        # ==========================================
        # 8. PUBLICATION DES ASSETS
        # ==========================================
        echo ''
        echo 'ðŸ“¦ Publication des assets...'
        php artisan vendor:publish --force --tag=livewire:assets --ansi --no-interaction 2>/dev/null && echo '  âœ“ Livewire assets' || true
        php artisan filament:assets 2>/dev/null && echo '  âœ“ Filament assets' || true

        # ==========================================
        # 9. PERMISSIONS DES FICHIERS
        # ==========================================
        echo ''
        echo 'ðŸ”’ Configuration des permissions...'
        # PropriÃ©taire
        chown -R www-data:www-data storage/ bootstrap/cache/
        echo '  âœ“ PropriÃ©taire: www-data'

        # Permissions fichiers
        find storage/ -type f -exec chmod 644 {} \\;
        find storage/ -type d -exec chmod 755 {} \\;
        find bootstrap/cache/ -type f -exec chmod 644 {} \\;
        find bootstrap/cache/ -type d -exec chmod 755 {} \\;
        echo '  âœ“ Permissions: 644 (fichiers) / 755 (dossiers)'

        # ==========================================
        # 10. RECONSTRUCTION DES CACHES PRODUCTION
        # ==========================================
        echo ''
        echo 'âš¡ Reconstruction des caches pour la production...'
        php artisan config:cache && echo '  âœ“ Config cache'
        php artisan route:cache && echo '  âœ“ Route cache'
        php artisan view:cache && echo '  âœ“ View cache'
        php artisan event:cache 2>/dev/null && echo '  âœ“ Event cache' || echo '  âš ï¸ Event cache non disponible'
        php artisan optimize && echo '  âœ“ Application optimized'
        php artisan filament:cache-components 2>/dev/null && echo '  âœ“ Filament components cached' || true

        # ==========================================
        # 11. NETTOYAGE DES ANCIENS LOGS
        # ==========================================
        echo ''
        echo 'ðŸ—‘ï¸ Nettoyage des anciens logs (>7 jours)...'
        find storage/logs/ -name '*.log' -mtime +7 -delete 2>/dev/null || true
        echo 'âœ… Logs nettoyÃ©s'

        # ==========================================
        # 12. REDÃ‰MARRAGE DES SERVICES
        # ==========================================
        echo ''
        echo 'ðŸ”„ RedÃ©marrage des services...'

        # RedÃ©marrage PHP-FPM
        if systemctl is-active --quiet php\${PHP_VERSION}-fpm; then
          systemctl restart php\${PHP_VERSION}-fpm
          echo \"  âœ“ PHP-FPM \${PHP_VERSION} redÃ©marrÃ©\"
        elif systemctl is-active --quiet php-fpm; then
          systemctl restart php-fpm
          echo '  âœ“ PHP-FPM redÃ©marrÃ©'
        else
          echo '  âš ï¸ PHP-FPM non trouvÃ©'
        fi

        # RedÃ©marrage du serveur web
        if systemctl is-active --quiet nginx; then
          systemctl restart nginx
          echo '  âœ“ Nginx redÃ©marrÃ©'
        elif systemctl is-active --quiet apache2; then
          systemctl restart apache2
          echo '  âœ“ Apache2 redÃ©marrÃ©'
        else
          echo '  âš ï¸ Serveur web non dÃ©tectÃ©'
        fi

        # RedÃ©marrage des workers Queue
        php artisan queue:restart 2>/dev/null && echo '  âœ“ Queue workers redÃ©marrÃ©s' || echo '  âš ï¸ Pas de workers'

        # ==========================================
        # 13. TEST DE SANTÃ‰
        # ==========================================
        echo ''
        echo 'ðŸ¥ Test de santÃ© de l'\''application...'
        sleep 5

        APP_URL=\$(php artisan tinker --execute=\"echo config('app.url');\" 2>/dev/null | tail -n1)
        if [ -n \"\$APP_URL\" ] && [ \"\$APP_URL\" != 'http://localhost' ]; then
          HTTP_CODE=\$(curl -s -o /dev/null -w '%{http_code}' \"\$APP_URL\" 2>/dev/null || echo '000')
          if [ \"\$HTTP_CODE\" = '200' ] || [ \"\$HTTP_CODE\" = '302' ]; then
            echo \"âœ… Application accessible (HTTP \$HTTP_CODE)\"
          else
            echo \"âš ï¸ Application retourne HTTP \$HTTP_CODE\"
          fi
        else
          echo 'âš ï¸ URL de l'\''application non configurÃ©e'
        fi

        # ==========================================
        # 14. SORTIE DU MODE MAINTENANCE
        # ==========================================
        echo ''
        echo 'âœ… DÃ©sactivation du mode maintenance...'
        php artisan up

        # ==========================================
        # RÃ‰SUMÃ‰ FINAL
        # ==========================================
        echo ''
        echo '================================================'
        echo 'ðŸŽ‰ DÃ‰PLOIEMENT TERMINÃ‰ AVEC SUCCÃˆS!'
        echo '================================================'
        echo \"ðŸ“Œ Commit dÃ©ployÃ©: \$NEW_COMMIT\"
        echo \"ðŸ“… Date: \$(date)\"
        echo \"ðŸ‘¤ Par: $GITLAB_USER_LOGIN\"
        echo \"ðŸ”¢ Pipeline: #$CI_PIPELINE_ID\"
        echo ''
        echo 'ðŸ“Š Actions effectuÃ©es:'
        echo '  âœ“ Backup base de donnÃ©es'
        echo '  âœ“ Code mis Ã  jour'
        echo '  âœ“ DÃ©pendances installÃ©es'
        echo '  âœ“ Migrations exÃ©cutÃ©es'
        echo '  âœ“ Documentation Swagger gÃ©nÃ©rÃ©e'
        echo '  âœ“ Caches optimisÃ©s'
        echo '  âœ“ Permissions configurÃ©es'
        echo '  âœ“ Services redÃ©marrÃ©s'
        echo '  âœ“ Application testÃ©e'
        echo ''
        echo 'ðŸ“ Commandes utiles:'
        echo '  â€¢ Logs: tail -f storage/logs/laravel.log'
        echo '  â€¢ Routes: php artisan route:list'
        echo \"  â€¢ Status: systemctl status php\${PHP_VERSION}-fpm nginx\"
        echo '================================================'
      "

  environment:
    name: production
    url: https://keyhomeback.neocraft.dev
    on_stop: stop:production

  only:
    - main

  when: manual  # Changez-en "on_success" pour auto-dÃ©ploiement

stop:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - sudo apt-get update && sudo apt-get install openssh-client rsync
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $VPS_USER@$VPS_HOST "
        cd $VPS_PATH
        echo 'ðŸ›‘ Mise en mode maintenance...'
        php artisan down
        echo 'âœ… Application en maintenance'
      "
  environment:
    name: production
    action: stop
  when: manual
  only:
    - main

# ==========================================
# STAGE: VERIFY - VÃ©rifications
# ==========================================
âœ… verify:health-check:
  stage: verify
  image: alpine:latest
  needs:
    - ðŸš€ deploy:production
  before_script:
    - apk add --no-cache curl
  script:
    - echo "ðŸ¥ Health check..."
    - sleep 10
    - |
      HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://votre-domaine.com || echo "000")

      if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
        echo "âœ… Application OK (HTTP $HTTP_CODE)"
      else
        echo "âŒ ERREUR (HTTP $HTTP_CODE)"
        exit 1
      fi

  only:
    - main
  allow_failure: true

âœ… verify:ssl:
  stage: verify
  image: alpine:latest
  needs:
    - ðŸš€ deploy:production
  before_script:
    - apk add --no-cache openssl
  script:
    - echo "ðŸ”’ VÃ©rification SSL..."
    - |
      DOMAIN="votre-domaine.com"
      EXPIRY=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
      echo "ðŸ“… Expiration SSL: $EXPIRY"
  only:
    - main
  allow_failure: true
  when: manual

# ==========================================
# STAGE: NOTIFY - Notifications
# ==========================================
ðŸ“¢ notify:success:
  stage: notify
  image: curlimages/curl:latest
  needs:
    - ðŸš€ deploy:production
  script:
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"âœ… DÃ©ploiement rÃ©ussi!\",
            \"attachments\": [{
              \"color\": \"good\",
              \"fields\": [
                {\"title\": \"Projet\", \"value\": \"$CI_PROJECT_NAME\", \"short\": true},
                {\"title\": \"Commit\", \"value\": \"$CI_COMMIT_SHORT_SHA\", \"short\": true},
                {\"title\": \"Pipeline\", \"value\": \"#$CI_PIPELINE_ID\", \"short\": true},
                {\"title\": \"Par\", \"value\": \"$GITLAB_USER_LOGIN\", \"short\": true}
              ]
            }]
          }"
        echo "âœ… Notification envoyÃ©e"
      else
        echo "â„¹ï¸ Notifications dÃ©sactivÃ©es"
      fi
  when: on_success
  only:
    - main
  allow_failure: true

ðŸ“¢ notify:failure:
  stage: notify
  image: curlimages/curl:latest
  needs:
    - ðŸš€ deploy:production
  script:
    - |
      if [ -n "$SLACK_WEBHOOK_URL" ]; then
        curl -X POST "$SLACK_WEBHOOK_URL" \
          -H 'Content-Type: application/json' \
          -d "{
            \"text\": \"âŒ DÃ©ploiement Ã©chouÃ©!\",
            \"attachments\": [{
              \"color\": \"danger\",
              \"fields\": [
                {\"title\": \"Projet\", \"value\": \"$CI_PROJECT_NAME\", \"short\": true},
                {\"title\": \"Pipeline\", \"value\": \"$CI_PIPELINE_URL\", \"short\": false}
              ]
            }]
          }"
      fi
  when: on_failure
  only:
    - main
  allow_failure: true

# ==========================================
# STAGE: MAINTENANCE - Rollback
# ==========================================
ðŸ”™ rollback:production:
  stage: maintenance
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ðŸ”™ ROLLBACK..."
    - |
      ssh $VPS_USER@$VPS_HOST "
        set -e

        echo '================================================'
        echo 'ðŸ”™ ROLLBACK PRODUCTION'
        echo '================================================'

        cd $VPS_PATH

        php artisan down || true

        if [ -f /tmp/last_commit_keyhome.txt ]; then
          LAST_COMMIT=\$(cat /tmp/last_commit_keyhome.txt)
          echo \"Retour au commit: \$LAST_COMMIT\"
          git reset --hard \$LAST_COMMIT
        else
          echo \"Retour au commit prÃ©cÃ©dent\"
          git reset --hard HEAD~1
        fi

        composer install --no-dev --optimize-autoloader --no-interaction

        php artisan migrate:rollback --step=1 --force

        php artisan optimize
        php artisan up

        echo ''
        echo 'âœ… ROLLBACK TERMINÃ‰'
      "

  when: manual
  only:
    - main

  environment:
    name: production

ðŸ§¹ maintenance:clear-cache:
  stage: maintenance
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $VPS_USER@$VPS_HOST "
        cd $VPS_PATH
        echo 'ðŸ§¹ Nettoyage des caches...'
        php artisan cache:clear
        php artisan config:clear
        php artisan route:clear
        php artisan view:clear
        echo 'âœ… Caches nettoyÃ©s!'
      "
  when: manual
  only:
    - main
