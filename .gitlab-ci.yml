stages:
  - test
  - deploy

# Configuration globale pour utiliser UNIQUEMENT votre Runner VPS
default:
  tags:
    - self-hosted-shell

# --- Ã‰TAPE 1 : TESTS ---
test_suite:
  stage: test
  variables:
    DB_CONNECTION: pgsql
    DB_HOST: 127.0.0.1
    DB_PORT: 5432
    DB_DATABASE: testing
    DB_USERNAME: postgres
    DB_PASSWORD: password # <--- Assurez-vous que ce mot de passe est correct pour votre VPS
  script:
    - echo "ðŸ§ª PrÃ©paration des tests sur le VPS..."
    - composer install --no-ansi --no-interaction
    - cp .env.example .env.testing
    - php artisan key:generate --env=testing
    # On force la crÃ©ation de la base de test si elle n'existe pas (optionnel mais recommandÃ©)
    # - sudo -u postgres psql -c "CREATE DATABASE testing;" || true
    - php artisan test --env=testing
  only:
    - branches
    - merge_requests

# --- Ã‰TAPE 2 : DÃ‰PLOIEMENT ---
production_deploy:
  stage: deploy
  script:
    - echo "ðŸš€ DÃ©ploiement local sur le VPS..."
    - cd /var/www/ImmoApp-Backend || exit 1
    # On s'assure d'Ãªtre sur la bonne branche avant le pull
    - git fetch origin
    - git checkout main
    - git pull origin main
    - bash deploy.sh
  only:
    - main
