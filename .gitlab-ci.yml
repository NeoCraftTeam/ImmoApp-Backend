stages:
  - build
  - test
  - deploy
  - cleanup

variables:
  # GitLab Container Registry variables
  APP_IMAGE: $CI_REGISTRY_IMAGE/app
  # On utilise le tag 'latest' pour la branche main, et le commit SHA pour les autres
  IMAGE_TAG: $CI_COMMIT_REF_SLUG

# Configuration globale pour utiliser votre Runner VPS
default:
  tags:
    - self-hosted-shell

# --- √âTAPE 1 : BUILD & PUSH TO REGISTRY ---
build_image:
  stage: build
  script:
    - echo "üèóÔ∏è Building and Pushing Docker Image to Registry..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build --pull -t $APP_IMAGE:$IMAGE_TAG .
    - docker push $APP_IMAGE:$IMAGE_TAG
  only:
    - branches

# --- √âTAPE 2 : TESTS (Utilisant l'image du Registry) ---
test_suite:
  stage: test
  variables:
    DB_CONNECTION: pgsql
    DB_HOST: 127.0.0.1
    DB_PORT: 5432
    DB_DATABASE: testing
    DB_USERNAME: gitlab-runner
    DB_PASSWORD: test_pass
  script:
    - echo "üß™ Running tests inside the built image context..."
    # On lance les tests sur le runner (qui a acc√®s √† Postgres localement)
    - composer install --no-ansi --no-interaction
    - cp .env.example .env.testing
    - php artisan key:generate --env=testing
    - php artisan migrate --env=testing --force
    - php artisan test --env=testing
  only:
    - branches

# --- √âTAPE 3 : D√âPLOIEMENT DEPUIS LE REGISTRY ---
production_deploy:
  stage: deploy
  script:
    - echo "üöÄ Deploying from Registry to VPS..."
    - cd /var/www/ImmoApp-Backend || exit 1
    
    # 1. Se connecter au registre sur le VPS
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    
    # 2. Mettre √† jour le fichier docker-compose pour pointer vers l'image du registre
    # On utilise une variable d'env pour l'image
    - export APP_IMAGE=$APP_IMAGE:main
    
    # 3. Pull et Relance rapide
    - docker-compose pull app
    - docker-compose up -d --no-build
    
    # 4. T√¢ches de maintenance habituelles
    - docker-compose exec -T app php artisan migrate --force
    - docker-compose exec -T app php artisan optimize
    - docker-compose exec -T app bash resetFilamentLivewire.sh
    
    # 5. Cr√©er le lien symbolique si manquant (notre r√©cent fix)
    - docker-compose exec -T app php artisan storage:link || true
    
  only:
    - main

# --- √âTAPE 4 : NETTOYAGE ---
cleanup:
  stage: cleanup
  script:
    - echo "üßπ Cleaning up old images..."
    - docker system prune -f
  when: always
  only:
    - main
