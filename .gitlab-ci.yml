stages:
  - quality
  - security
  - build
  - test
  - deploy
  - notify
  - cleanup

variables:
  APP_IMAGE: $CI_REGISTRY_IMAGE/app
  IMAGE_TAG: $CI_COMMIT_REF_SLUG

default:
  tags:
    - self-hosted-shell

# --- √âTAPE 1 : QUALITY (Lint & Static Analysis) ---
phpstan:
  stage: quality
  script:
    - echo "üîç Running PHPStan Analysis..."
    - composer install --no-interaction
    - ./vendor/bin/phpstan analyse
  only:
    - branches

style_check:
  stage: quality
  script:
    - echo "üíÖ Checking Code Style (Pint)..."
    - composer install --no-interaction
    - ./vendor/bin/pint --test
  only:
    - branches

# --- √âTAPE 2 : SECURITY ---
composer_security:
  stage: security
  script:
    - echo "üõ°Ô∏è Checking PHP Dependencies Security..."
    - composer audit
  only:
    - branches

# --- √âTAPE 3 : BUILD & PUSH ---
build_image:
  stage: build
  script:
    - echo "üèóÔ∏è Building Docker Image..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build --pull -t $APP_IMAGE:$IMAGE_TAG .
    - docker push $APP_IMAGE:$IMAGE_TAG
    - docker logout $CI_REGISTRY
  only:
    - branches

# --- √âTAPE 4 : TESTS ---
test_suite:
  stage: test
  variables:
    DB_CONNECTION: pgsql
    DB_HOST: 127.0.0.1
    DB_PORT: 5432
    DB_DATABASE: testing
    DB_USERNAME: gitlab-runner
    DB_PASSWORD: test_pass
  script:
    - echo "üß™ Running Test Suite..."
    - composer install --no-ansi --no-interaction
    - cp .env.example .env.testing
    - php artisan key:generate --env=testing
    - php artisan migrate --env=testing --force
    - php artisan test --env=testing
  only:
    - branches

# --- √âTAPE 5 : D√âPLOIEMENT ---
production_deploy:
  stage: deploy
  script:
    - echo "üöÄ D√©ploiement via Registry (Pure Docker)..."
    # 1. On recr√©e la structure des dossiers
    - mkdir -p /var/www/ImmoApp-Backend/.docker/nginx/conf.d
    - cp docker-compose.yml /var/www/ImmoApp-Backend/docker-compose.yml
    # 2. On copie explicitement le contenu de la config Nginx
    - cp -rf .docker/nginx/conf.d/. /var/www/ImmoApp-Backend/.docker/nginx/conf.d/
    - cd /var/www/ImmoApp-Backend || exit 1
    
    # 3. Authentification au registre
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    
    # 4. On d√©finit et on injecte l'image
    - export FULL_IMAGE="${CI_REGISTRY_IMAGE}/app:main"
    - APP_IMAGE=$FULL_IMAGE docker compose pull app
    - APP_IMAGE=$FULL_IMAGE docker compose up -d --no-build
    - APP_IMAGE=$FULL_IMAGE docker compose restart web
    
    # 5. T√¢ches Laravel (Via Docker)
    - APP_IMAGE=$FULL_IMAGE docker compose exec -T app php artisan migrate --force
    - APP_IMAGE=$FULL_IMAGE docker compose exec -T app php artisan optimize
    - APP_IMAGE=$FULL_IMAGE docker compose exec -T app bash resetFilamentLivewire.sh
    - APP_IMAGE=$FULL_IMAGE docker compose exec -T app php artisan storage:link || true
    
    - docker logout $CI_REGISTRY
  only:
    - main

# --- √âTAPE 6 : NOTIFICATIONS ---
notify_slack_success:
  stage: notify
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
      --data "{
        \"text\": \"‚úÖ *[BACKEND] D√©ploiement R√©ussi !*\n\n*Auteur:* $GITLAB_USER_NAME\n*Branche:* \`$CI_COMMIT_REF_NAME\`\n*Message:* _${CI_COMMIT_TITLE}_\n\nüîó <$CI_PROJECT_URL/-/commit/$CI_COMMIT_SHA|Voir le commit> | <$CI_PROJECT_URL/-/pipelines/$CI_PIPELINE_ID|Voir la pipeline>\"
      }" $SLACK_WEBHOOK_URL
  when: on_success
  only:
    - main

notify_slack_failure:
  stage: notify
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
      --data "{
        \"text\": \"‚ùå *[BACKEND] √âchec de la Pipeline !*\n\n*√âtape:* \`$CI_JOB_STAGE\`\n*Auteur:* $GITLAB_USER_NAME\n*Branche:* \`$CI_COMMIT_REF_NAME\`\n\nüö® <$CI_PROJECT_URL/-/pipelines/$CI_PIPELINE_ID|V√©rifier l'erreur imm√©diatement>\"
      }" $SLACK_WEBHOOK_URL
  when: on_failure
  only:
    - branches

# --- √âTAPE 7 : NETTOYAGE ---
cleanup:
  stage: cleanup
  script:
    - echo "üßπ Cleaning up..."
    - docker system prune -f
  when: always
  only:
    - main
