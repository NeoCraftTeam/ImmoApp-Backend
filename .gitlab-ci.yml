stages:
  - quality
  - security
  - build
  - test
  - deploy
  - notify
  - cleanup

variables:
  APP_IMAGE: $CI_REGISTRY_IMAGE/app
  IMAGE_TAG: $CI_COMMIT_REF_SLUG

default:
  tags:
    - self-hosted-shell

# --- √âTAPE 1 : QUALITY (Lint & Static Analysis) ---
phpstan:
  stage: quality
  script:
    - echo "üîç Running PHPStan Analysis..."
    - composer install --no-interaction
    - ./vendor/bin/phpstan analyse
  only:
    - branches

style_check:
  stage: quality
  script:
    - echo "üíÖ Checking Code Style (Pint)..."
    - ./vendor/bin/pint --test
  only:
    - branches

# --- √âTAPE 2 : SECURITY ---
composer_security:
  stage: security
  script:
    - echo "üõ°Ô∏è Checking PHP Dependencies Security..."
    - composer audit
  only:
    - branches

# --- √âTAPE 3 : BUILD & PUSH ---
build_image:
  stage: build
  script:
    - echo "üèóÔ∏è Building Docker Image..."
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - docker build --pull -t $APP_IMAGE:$IMAGE_TAG .
    - docker push $APP_IMAGE:$IMAGE_TAG
    - docker logout $CI_REGISTRY
  only:
    - branches

# --- √âTAPE 4 : TESTS ---
test_suite:
  stage: test
  variables:
    DB_CONNECTION: pgsql
    DB_HOST: 127.0.0.1
    DB_PORT: 5432
    DB_DATABASE: testing
    DB_USERNAME: gitlab-runner
    DB_PASSWORD: test_pass
  script:
    - echo "üß™ Running Test Suite..."
    - composer install --no-ansi --no-interaction
    - cp .env.example .env.testing
    - php artisan key:generate --env=testing
    - php artisan migrate --env=testing --force
    - php artisan test --env=testing
  only:
    - branches

# --- √âTAPE 5 : D√âPLOIEMENT ---
production_deploy:
  stage: deploy
  script:
    - echo "üöÄ Deploying to VPS..."
    - cd /var/www/ImmoApp-Backend || exit 1
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
    - export APP_IMAGE=$APP_IMAGE:main
    - docker-compose pull app
    - docker-compose up -d --no-build
    - docker-compose exec -T app php artisan migrate --force
    - docker-compose exec -T app php artisan optimize
    - docker-compose exec -T app bash resetFilamentLivewire.sh
    - docker-compose exec -T app php artisan storage:link || true
    - docker logout $CI_REGISTRY
  only:
    - main

# --- √âTAPE 6 : NOTIFICATIONS ---
notify_slack_success:
  stage: notify
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\":\"‚úÖ *KeyHome - D√©ploiement R√©ussi !* \n*Branche:* $CI_COMMIT_REF_NAME\n*Commit:* $CI_COMMIT_TITLE\n<https://gitlab.com/$CI_PROJECT_PATH/-/pipelines/$CI_PIPELINE_ID|Voir la pipeline>\"}" \
      $SLACK_WEBHOOK_URL
  when: on_success
  only:
    - main

notify_slack_failure:
  stage: notify
  script:
    - |
      curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\":\"‚ùå *KeyHome - √âchec de la Pipeline !* \n*√âtape:* $CI_JOB_STAGE\n*Branche:* $CI_COMMIT_REF_NAME\n<https://gitlab.com/$CI_PROJECT_PATH/-/pipelines/$CI_PIPELINE_ID|V√©rifier l'erreur>\"}" \
      $SLACK_WEBHOOK_URL
  when: on_failure
  only:
    - branches

# --- √âTAPE 7 : NETTOYAGE ---
cleanup:
  stage: cleanup
  script:
    - echo "üßπ Cleaning up..."
    - docker system prune -f
  when: always
  only:
    - main
