# Pipeline GitLab CI/CD pour Laravel avec s√©curit√© et d√©ploiement

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml

stages:
  - test
  - security
  - deploy

variables:
  # Variables PostgreSQL pour les tests
  POSTGRES_DB: laravel_test
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: secret
  DB_HOST: postgres
  DB_CONNECTION: pgsql
  # Variables pour SAST
  SAST_EXCLUDED_PATHS: "spec,test,tests,tmp,vendor"
  # Variables pour le d√©ploiement (√† d√©finir dans GitLab CI/CD Settings > Variables)
  # VPS_HOST: votre-serveur.com
  # VPS_USER: votre-utilisateur
  # VPS_PATH: /var/www/votre-projet
  # SSH_PRIVATE_KEY: votre cl√© SSH priv√©e (encod√©e en Base64)

# Tests unitaires et fonctionnels
test:keyhome:
  stage: test
  image: php:8.4-fpm
  services:
    - name: postgis/postgis:15-3.3
      alias: postgres
  variables:
    # Variables pour Laravel pendant les tests
    DB_CONNECTION: pgsql
    DB_HOST: postgres
    DB_PORT: 5432
    DB_DATABASE: laravel_test
    DB_USERNAME: postgres
    DB_PASSWORD: secret
  before_script:
    # Installation des d√©pendances syst√®me
    - apt-get update -qq && apt-get install -y -qq git curl libzip-dev libpq-dev unzip libicu-dev
    - docker-php-ext-configure intl
    - docker-php-ext-install pdo_pgsql pgsql zip intl exif

    # Installation de Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

    # Installation des d√©pendances Laravel
    - composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts

    # Configuration de l'environnement de test
    - cp .env.example .env
    - php artisan key:generate

    # Configurer les variables de base de donn√©es dans .env
    - echo "DB_CONNECTION=pgsql" >> .env
    - echo "DB_HOST=postgres" >> .env
    - echo "DB_PORT=5432" >> .env
    - echo "DB_DATABASE=laravel_test" >> .env
    - echo "DB_USERNAME=postgres" >> .env
    - echo "DB_PASSWORD=secret" >> .env

    - php artisan config:clear

  script:
    # Ex√©cution des migrations (PostGIS sera activ√© automatiquement si configur√© dans les migrations)
    - php artisan migrate --force

    # Ex√©cution des tests
    - php artisan test

  only:
    - main
    - develop
    - merge_requests

# D√©ploiement sur VPS
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    # Installation d'OpenSSH
    - apk add --no-cache openssh-client git

    # Configuration SSH
    - eval $(ssh-agent -s)
    # D√©coder la cl√© priv√©e depuis Base64
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts

  script:
    - |
      ssh $VPS_USER@$VPS_HOST "
        set -e
        echo 'üöÄ D√©but du d√©ploiement...'

        # Navigation vers le r√©pertoire du projet
        cd $VPS_PATH

        # Mise en mode maintenance
        php artisan down || true

        # Mise √† jour du code
        echo 'üì• R√©cup√©ration du code...'
        git fetch origin main
        git reset --hard origin/main

        # Installation/mise √† jour des d√©pendances Composer
        echo 'üì¶ Installation des d√©pendances...'
        composer install --no-dev --optimize-autoloader --no-interaction

        # Optimisation et nettoyage
        echo 'üßπ Nettoyage des caches...'
        php artisan cache:clear
        php artisan config:clear
        php artisan route:clear
        php artisan view:clear

        # V√©rification et activation de l'extension PostGIS (si n√©cessaire)
        echo 'üó∫Ô∏è  V√©rification de PostGIS...'
        php artisan db:check-postgis || echo 'PostGIS d√©j√† activ√© ou commande non disponible'

        # Ex√©cution des migrations
        echo 'üóÑÔ∏è  Ex√©cution des migrations...'
        php artisan migrate --force

        # Optimisation pour la production
        echo '‚ö° Optimisation...'
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        php artisan event:cache

        # Permissions des fichiers
        echo 'üîí Configuration des permissions...'
        chmod -R 775 storage bootstrap/cache
        chown -R www-data:www-data storage bootstrap/cache

        # Red√©marrage des workers Queue (si vous utilisez Laravel Queue)
        # php artisan queue:restart

        # Sortie du mode maintenance
        php artisan up

        echo '‚úÖ D√©ploiement termin√© avec succ√®s!'
      "

  only:
    - main

  environment:
    name: production
    url: https://keyhomeback.neocraft.dev
