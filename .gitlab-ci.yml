stages:
  - test
  - deploy
  - cleanup

# Configuration globale pour utiliser UNIQUEMENT votre Runner VPS
default:
  tags:
    - self-hosted-shell

# --- Ã‰TAPE 1 : TESTS ---
test_suite:
  stage: test
  variables:
    DB_CONNECTION: pgsql
    DB_HOST: 127.0.0.1
    DB_PORT: 5432
    DB_DATABASE: testing
    DB_USERNAME: gitlab-runner
    DB_PASSWORD: test_pass # Le mot de passe dÃ©fini en Ã©tape 1
  script:
    - echo "ðŸ§ª PrÃ©paration des tests sur le VPS..."
    - composer install --no-ansi --no-interaction
    - cp .env.example .env.testing
    - php artisan key:generate --env=testing
    # On vÃ©rifie que le style et la qualitÃ© du code sont parfaits
    - ./vendor/bin/pint --test
    - ./vendor/bin/rector --dry-run
    - php artisan migrate --env=testing --force
    - php artisan test --env=testing
  only:
    - branches
    - merge_requests

# --- Ã‰TAPE 2 : DÃ‰PLOIEMENT DOCKER ---
production_deploy:
  stage: deploy
  tags:
    - self-hosted-shell
  script:
    - echo "ðŸš€ DÃ©ploiement Docker sur le VPS..."
    - cd /var/www/ImmoApp-Backend || exit 1
    
    # 1. Mise Ã  jour du code sur l'hÃ´te et nettoyage radical des caches
    - sudo chown -R gitlab-runner:www-data .
    - git remote set-url origin https://gitlab-ci-token:${CI_JOB_TOKEN}@$CI_SERVER_HOST/$CI_PROJECT_PATH.git
    - git fetch origin
    - git checkout main
    - git reset --hard origin/main
    - git clean -fd
    - rm -f bootstrap/cache/*.php # Supprime les rÃ©sidus de config systÃ¨me
    
    # 2. Nettoyage et Reconstruction
    # On force l'arrÃªt des anciens conteneurs pour libÃ©rer les ports et Ã©viter les KeyError
    - docker-compose down --remove-orphans || true
    - docker-compose up -d --build
    
    # 3. ExÃ©cution des tÃ¢ches Laravel Ã  l'INTÃ‰RIEUR du conteneur
    # On active PostGIS en utilisant les variables internes du conteneur ($POSTGRES_USER et $POSTGRES_DB)
    - docker-compose exec -T db sh -c 'psql -U $POSTGRES_USER -d $POSTGRES_DB -c "CREATE EXTENSION IF NOT EXISTS postgis;"'
    - docker-compose exec -T app php artisan migrate --force
    - docker-compose exec -T app php artisan optimize
    - docker-compose exec -T app bash resetFilamentLivewire.sh # Le script est Ã  la racine
    
  only:
    - main

# --- Ã‰TAPE 3 : NETTOYAGE ---
cleanup:
  stage: cleanup
  tags:
    - self-hosted-shell
  script:
    - echo "ðŸ§¹ Nettoyage des images et cache Docker sur le VPS..."
    - docker system prune -f
  when: always
  only:
    - main
