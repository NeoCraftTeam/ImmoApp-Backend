image: php:8.4

stages:
  - test
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - vendor/

services:
  - name: postgis/postgis:15-3.3
    alias: postgres

variables:
  DB_CONNECTION: pgsql
  DB_HOST: postgres
  DB_PORT: 5432
  DB_DATABASE: testing
  DB_USERNAME: postgres
  DB_PASSWORD: secret

test:
  stage: test
  before_script:
    # Install system dependencies and PHP extensions
    - apt-get update && apt-get install -y unzip git libzip-dev libicu-dev libpq-dev
    - docker-php-ext-install pdo_pgsql zip intl gettext exif
    # Install Composer
    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
    - composer install --no-ansi --no-interaction --no-progress --prefer-dist
    - cp .env.example .env
    - php artisan key:generate
  script:
    - php artisan test
    - ./vendor/bin/pint --test
  only:
    - branches
    - merge_requests

deploy:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
  script:
    - |
      ssh $SSH_USER@$VPS_HOST "
        set -e
        cd $VPS_PATH

        # Pull latest changes
        git pull origin main

        # Install dependencies
        composer install --no-dev --optimize-autoloader --no-interaction

        # Run migrations
        php artisan migrate --force

        # Clear and Cache Configs
        php artisan optimize:clear
        php artisan optimize
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        php artisan event:cache

        # Restart Queue Workers
        php artisan queue:restart
      "
  only:
    - main
